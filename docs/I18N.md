# Internationalization (i18n) – SaaS Platform (v6.4, Payload 3.63.0)

This document details the multilingual architecture and translation flow for both Admin and Site environments.

> **Update v6.4**  
> - Bổ sung lưu ý về **Payload 3.63.0 – Duplicate in [Select locales]**.  
> - Nhấn mạnh: **không fix cứng ngôn ngữ** trong code – mọi label phải đi qua i18n JSON hoặc Payload localized fields.  
> - Bổ sung guideline cho form/frontend để tránh hard-code `"Email"`, `"Message"`, ...

---

## 1. Overview

The SaaS platform supports **multi-language at all levels**:

- Admin interface (user-based preference).
- Site interface (per-site locale configuration).
- Theme & content translation via Payload CMS (`localized: true` + multi-locale content).
- JSON-based locale files (auto-detect & hot-reload).

---

## 2. Directory Structure

```text
packages/i18n/
 ├─ config/
 │   ├─ locales.ts
 │   └─ i18n-config.ts
 ├─ locales/
 │   ├─ vi/
 │   │   ├─ common.json
 │   │   ├─ validation.json
 │   │   ├─ date-time.json
 │   │   ├─ admin-core.json
 │   │   ├─ admin-users.json
 │   │   ├─ admin-billing.json
 │   │   ├─ site-core.json
 │   │   ├─ site-landing.json
 │   │   ├─ theme-default.json
 │   │   └─ theme-dark.json
 │   ├─ en/
 │   │   ├─ ...
 │   └─ ja/
 │       ├─ ...
 └─ lib/
     ├─ loadNamespaces.ts
     └─ types.ts
```

### 2.1 Developer Checklist

- Tạo namespace JSON trước khi viết UI mới.
- Nếu thiếu key → thêm vào cả `vi`, `en`, `ja`; không đẩy placeholder tiếng Việt/Anh vào code.
- Sử dụng `loadNamespaces()` + `createTranslator()` để lấy `t` trong cả Server Component và Client Component.

---

## 3. Language Detection

### Admin

- Language determined by `user.adminLanguage` field in Payload.  
- Default fallback: `"en"`.  
- Admin locale auto-loads corresponding JSON namespaces (e.g. `admin-core.json`, `admin-users.json`).

### Site

- Locale determined by URL prefix (`/vi`, `/en`, `/ja`, …).  
- Fallback to default site locale (in `Sites.locales`).  
- If no prefix, use `Sites.defaultLocale`.

---

## 4. JSON File Convention

Each JSON file corresponds to a namespace.

Example (`site-core.json`):

```json
{
  "header": {
    "home": "Trang chủ",
    "about": "Giới thiệu"
  },
  "footer": {
    "contact": "Liên hệ",
    "privacy": "Chính sách bảo mật"
  }
}
```

> Quy tắc: **không** hard-code string tiếng Việt / tiếng Anh trong component.  
> Mọi text hiển thị đều dùng key, ví dụ: `"site-core:header.home"`.

---

## 5. Adding a New Language

1. Copy folder `vi/` → rename to target language (e.g., `fr/`).  
2. Translate JSON files inside.  
3. No code changes needed – system auto-detects the new folder.  
4. Update `packages/i18n/config/locales.ts` để thêm locale mới vào danh sách hỗ trợ.

---

## 6. Dynamic Loading

Each namespace loaded only when needed.

Example in frontend:

```tsx
import { useTranslation } from "@bsweb/i18n";

const { t } = useTranslation("site-core");

return <h1>{t("header.home")}</h1>;
```

- App Router có thể dùng **server components**: truyền sẵn `messages` xuống client.
- Trên admin, mỗi screen chỉ load namespaces cần thiết (vd: `admin-users`, `validation`).

---

## 7. i18n in Admin

Admin UI uses the same system.

Example:

```tsx
<label className="block text-sm font-medium">
  {t("admin-users.email.label")}
</label>
<input
  placeholder={t("admin-users.email.placeholder")}
/>
```

> **Lưu ý:**  
> - Tuyệt đối tránh:  
>   ```tsx
>   <label className="block text-sm font-medium">Email</label>
>   ```  
> - Thay bằng key i18n 100%.  
> - Việc đổi ngôn ngữ admin là **per user**, đọc từ `Users.adminLanguage`.

---

## 8. i18n in Themes

Each theme includes its own locale definitions.

Example:

```text
packages/themes/company-industrial/locales/vi.json
packages/themes/company-industrial/locales/en.json
```

Merged during runtime:

```ts
const translations = merge(globalMessages, themeMessages);
```

- `globalMessages`: từ `packages/i18n/locales/*/*.json` (common, site-core, …).  
- `themeMessages`: từ theme cụ thể.  

Theme có thể override key global nếu cần (ưu tiên theme-level).

---

## 9. Validation & Date-Time Localization

### Validation Messages (`validation.json`)

```json
{
  "required": "Trường này là bắt buộc",
  "email": "Địa chỉ email không hợp lệ"
}
```

### Date-Time Formatting (`date-time.json`)

```json
{
  "shortDate": "DD/MM/YYYY",
  "longDate": "DD MMMM, YYYY"
}
```

Các format này được dùng chung cho Admin & Site (moment/dayjs/date-fns).

---

## 10. Integration with Payload CMS

Each collection that supports multilingual fields uses:

```ts
localized: true
```

Example:

```ts
fields: [
  {
    name: "title",
    type: "text",
    localized: true
  },
  {
    name: "content",
    type: "richText",
    localized: true
  }
];
```

Payload automatically stores translations per locale và hiển thị UI tab per locale trong admin.

> **Note:**  
> - Ưu tiên dùng `localized: true` thay vì tự tạo `translations[]` nếu không cần logic đặc biệt.  
> - Các field business-level trong `SCHEMA-MASTER.md` giữ dạng neutral (có `locale` + `translations` array) để không khóa chặt 1 cách triển khai.

---

## 11. Payload 3.63.0 – Duplicate in [Select Locales]

Payload 3.63.0 bổ sung tính năng **“Duplicate in [Select locales]”** trên UI:

- Cho phép nhân bản 1 document từ 1 locale nguồn sang nhiều locale đích.  
- Phù hợp với use case của anh:  
  - Viết nội dung gốc ở `vi` → Duplicate sang `en`, `ja`, …  
  - Sau đó sửa lại từng bản dịch hoặc nhờ AI assistant dịch.

**Quy ước sử dụng:**

- Mặc định, content editor sẽ:
  1. Tạo content ở **locale chính** của site (ví dụ `vi`).  
  2. Dùng **Duplicate in locales** để tạo bản sao cho `en`, `ja`, …  
  3. Chỉnh lại text hoặc dùng AI Translate hook.

- Chúng ta **không** viết thêm logic đặc biệt; chỉ document rõ cách dùng cho end user trong ONBOARDING / HANDBOOK.

---

## 12. Caching & Performance

- Locale JSON cached in Redis (per tenant + site + lang).  
- Hash-based invalidation on JSON file update (dev) hoặc deploy mới.  
- Fast i18n switch via dynamic import (`import()`).  
- Preload all admin JSON files for active language sau khi user login vào admin.

---

## 13. AI Translation Hooks

When AI Translation enabled:

1. User creates or edits content in source locale.  
2. System auto-generates translated fields (via Assistant API) for target locales.  
3. Translation stored in respective locales by:
   - Ghi trực tiếp vào field `localized: true` (per locale), hoặc  
   - Cập nhật document hay gọi workflow riêng (tùy collection).

Configurable in `AiSettings`:

```json
{
  "autoTranslate": true,
  "sourceLocale": "vi",
  "targetLocales": ["en", "ja"]
}
```

> AI chỉ được gọi khi bật trong `AiSettings.featuresEnabled.translate === true` và khi site có cấu hình API key hợp lệ.

---

## 14. Fallback Strategy

Priority:

1. Requested language.  
2. Site default language.  
3. English (`en`).  

If key missing, UI displays `[missing]` badge in dev mode; trong production fallback sang key/raw string để tránh crash.

---

## 15. Multi-tenant Locale Isolation

Each tenant can define its own supported locales:

```json
{
  "tenantId": "t5g",
  "locales": ["vi", "en", "ja"]
}
```

Only those locales are active for its sites.

- `Sites.locales[]` phải là subset của `Tenants.locales`.  
- License per site có thể giới hạn số lượng locales được bật.

---

## 16. Testing

Run translation validation:

```bash
pnpm i18n:check
```

Checks for:

- Missing keys across languages.  
- Inconsistent placeholders (`{name}`, `{count}` …).  
- Invalid JSON format.  
- Namespace không được sử dụng (optional).

---

## 17. Guidelines for Forms & UI Components

Để tránh hard-code text như `"Email"`, `"Message"`:

- Mọi label/placeholder trong form phải dùng key i18n.

Example (site contact form):

```tsx
<label className="block text-sm font-medium">
  {t("site-forms:contact.email.label")}
</label>
<input
  type="email"
  placeholder={t("site-forms:contact.email.placeholder")}
/>
```

Trong `site-forms.json`:

```json
{
  "contact": {
    "email": {
      "label": "Email",
      "placeholder": "Nhập địa chỉ email của bạn"
    },
    "message": {
      "label": "Nội dung",
      "placeholder": "Nhập nội dung cần tư vấn"
    }
  }
}
```

> Nhờ đó, khi bật ngôn ngữ khác (`en`, `ja`), chỉ cần dịch file JSON, **không cần sửa code**.

---

## 18. Future Enhancements

- Real-time collaborative translation editor.  
- Export/import PO files cho đội dịch chuyên nghiệp.  
- AI translation review via Assistant.  
- Dynamic RTL (Arabic/Hebrew) support.  
- UI cho việc sử dụng “Duplicate in locales” với hướng dẫn chi tiết trong Admin.

---

## 19. Contacts

- **Localization Lead:** i18n@yourdomain.com  
- **AI Integration:** ai@yourdomain.com  
- **Support:** support@yourdomain.com
